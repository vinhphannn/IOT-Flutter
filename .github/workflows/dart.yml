name: iOS Unsigned IPA Release

on:
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
      # 1. Checkout source
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Setup Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          architecture: x64

      # 3. Get Dart dependencies
      - name: Flutter pub get
        run: flutter pub get

      # 4. TẠO/UPDATE iOS project (QUAN TRỌNG)
      - name: Setup iOS project
        run: |
          # Kiểm tra và tạo iOS project nếu cần
          if [ ! -d "ios" ] || [ ! -f "ios/Runner.xcworkspace" ]; then
            echo "Creating iOS project..."
            flutter create --platforms=ios --org com.yourcompany .
          else
            echo "iOS project already exists, updating..."
            flutter precache --ios
          fi
          
          # Hiển thị cấu trúc thư mục để debug
          echo "Project structure:"
          find . -name "Podfile" -o -name "*.xcodeproj" -o -name "*.xcworkspace" | head -20

      # 5. Generate Flutter iOS dependencies (tạo .flutter-plugins, v.v.)
      - name: Generate Flutter dependencies
        run: flutter pub get

      # 6. Build iOS để tạo Podfile nếu chưa có
      - name: Build iOS (generate Podfile)
        run: |
          # Lệnh này sẽ tạo/update Podfile với các Flutter plugin
          flutter build ios --no-codesign --simulator
          # Xóa build tạm để tiết kiệm không gian
          rm -rf build/ios

      # 7. Install CocoaPods
      - name: Install CocoaPods
        run: |
          # Cài đặt CocoaPods nếu chưa có
          which pod || sudo gem install cocoapods
          
          # Cập nhật repo và install pods
          cd ios
          pod repo update
          pod install --verbose

      # 8. Xcode build unsigned
      - name: Xcode build unsigned
        run: |
          cd ios
          xcodebuild \
            -workspace Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -sdk iphoneos \
            -destination 'generic/platform=iOS' \
            CONFIGURATION_BUILD_DIR=$GITHUB_WORKSPACE/build/ios/iphoneos \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            clean build

      # ... các bước còn lại giữ nguyên
